name: sonarcloud

on:
  push:
    paths:
      - 'src/**'
      - 'Justfile'
      - '.github/workflows/main.yml'
      - 'Dockerfile'
      - '.dockerignore'

  pull_request:
    branches:
      - master
    paths:
      - 'src/**'
      - 'Justfile'
      - '.github/workflows/main.yml'

jobs:

  sonar:
    if: github.ref == 'refs/heads/master' || github.event_name == 'pull_request'
    needs: [tests]
    runs-on: ubuntu-latest
    steps:

      - name: set envs
        run: |
          echo ::set-env name=VERSION::$(jq -r .version src/package.json)

      - name: checkout
        uses: actions/checkout@v2

      - name: setup node
        uses: actions/setup-node@v1
        with:
          node-version: '12.1'

      - name: install nyc & deps
        run: cd src && npm i nyc@15.0.0 -g && npm i --save-dev

      # https://github.com/marketplace/actions/sonar-scanner
      # https://github.com/SonarSource/sonar-scanner-cli/releases
      - name: setup sonarqube
        uses: warchant/setup-sonar-scanner@v1
        with:
          version: 4.3.0.2102

      - name: run tests (again)
        run: cd src && npm test

      - name: run sonarqube
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: sonar-scanner
             -Dsonar.login=${{ secrets.SONAR_TOKEN }}
             -Dsonar.organization=dmitry-ee
             -Dsonar.host.url=https://sonarcloud.io/
             -Dsonar.projectKey=dmitry-ee_tendermint-prometheus-exporter
             -Dsonar.projectVersion=${{ env.VERSION }}
             -Dsonar.javascript.lcov.reportPaths=src/coverage/lcov-report
